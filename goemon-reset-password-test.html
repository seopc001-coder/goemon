<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šãƒ†ã‚¹ãƒˆ | äº”å³è¡›é–€</title>
    <link rel="stylesheet" href="./css/goemon-style.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 60px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .code-box {
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <header class="header-simple">
        <div class="container">
            <div class="header-logo">
                <a href="https://goemon-flame.vercel.app/">
                    <h1>äº”å³è¡›é–€</h1>
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="test-container">
            <h1>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š - è¨ºæ–­ãƒšãƒ¼ã‚¸</h1>
            <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã®å•é¡Œã‚’è¨ºæ–­ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚</p>

            <div class="test-section">
                <h3>ğŸ” URLãƒã‚§ãƒƒã‚¯</h3>
                <div class="code-box">
                    <strong>ç¾åœ¨ã®URL:</strong><br>
                    <span id="currentUrl"></span>
                </div>
                <div class="code-box">
                    <strong>URLãƒãƒƒã‚·ãƒ¥:</strong><br>
                    <span id="hashParams"></span>
                </div>
                <div id="urlStatus" class="status info">è§£æä¸­...</div>
            </div>

            <div class="test-section">
                <h3>ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±</h3>
                <div id="tokenInfo" class="code-box">ãƒã‚§ãƒƒã‚¯ä¸­...</div>
                <div id="tokenStatus" class="status info">è§£æä¸­...</div>
            </div>

            <div class="test-section">
                <h3>ğŸ“Š Supabaseæ¥ç¶šçŠ¶æ…‹</h3>
                <div id="supabaseStatus" class="status info">ãƒã‚§ãƒƒã‚¯ä¸­...</div>
            </div>

            <div class="test-section">
                <h3>ğŸ“ ãƒ†ã‚¹ãƒˆçµæœ</h3>
                <div id="testResults"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <a href="https://goemon-flame.vercel.app/goemon-reset-password.html"
                   style="display: inline-block; padding: 12px 24px; background: #d63384; color: white; text-decoration: none; border-radius: 8px;">
                    å®Ÿéš›ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šãƒšãƒ¼ã‚¸ã¸
                </a>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./js/supabase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            runDiagnostics();
        });

        async function runDiagnostics() {
            const results = [];

            // 1. URLæƒ…å ±ã‚’è¡¨ç¤º
            const currentUrl = window.location.href;
            const hashParams = window.location.hash;

            document.getElementById('currentUrl').textContent = currentUrl;
            document.getElementById('hashParams').textContent = hashParams || '(ãªã—)';

            // 2. URLãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è§£æ
            const urlStatus = document.getElementById('urlStatus');
            if (hashParams) {
                urlStatus.className = 'status success';
                urlStatus.textContent = 'âœ… URLãƒãƒƒã‚·ãƒ¥ãŒå­˜åœ¨ã—ã¾ã™';
                results.push('âœ… URLãƒãƒƒã‚·ãƒ¥: å­˜åœ¨');
            } else {
                urlStatus.className = 'status error';
                urlStatus.textContent = 'âŒ URLãƒãƒƒã‚·ãƒ¥ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰æ­£ã—ããƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                results.push('âŒ URLãƒãƒƒã‚·ãƒ¥: ãªã—');
            }

            // 3. ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’è§£æ
            const tokenInfo = document.getElementById('tokenInfo');
            const tokenStatus = document.getElementById('tokenStatus');

            try {
                const params = new URLSearchParams(hashParams.substring(1));
                const accessToken = params.get('access_token');
                const type = params.get('type');
                const refreshToken = params.get('refresh_token');

                let tokenHtml = '';
                tokenHtml += `<strong>access_token:</strong> ${accessToken ? 'âœ… å­˜åœ¨ (' + accessToken.substring(0, 20) + '...)' : 'âŒ ãªã—'}<br>`;
                tokenHtml += `<strong>type:</strong> ${type || 'âŒ ãªã—'}<br>`;
                tokenHtml += `<strong>refresh_token:</strong> ${refreshToken ? 'âœ… å­˜åœ¨' : 'âŒ ãªã—'}`;

                tokenInfo.innerHTML = tokenHtml;

                if (accessToken && type === 'recovery') {
                    tokenStatus.className = 'status success';
                    tokenStatus.textContent = 'âœ… ãƒˆãƒ¼ã‚¯ãƒ³ã¯æ­£å¸¸ã§ã™';
                    results.push('âœ… ãƒˆãƒ¼ã‚¯ãƒ³: æ­£å¸¸');
                } else {
                    tokenStatus.className = 'status error';
                    tokenStatus.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¸æ­£ã¾ãŸã¯ä¸è¶³ã—ã¦ã„ã¾ã™';
                    results.push('âŒ ãƒˆãƒ¼ã‚¯ãƒ³: ä¸æ­£');
                }
            } catch (error) {
                tokenInfo.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                tokenStatus.className = 'status error';
                tokenStatus.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³è§£æã‚¨ãƒ©ãƒ¼';
                results.push('âŒ ãƒˆãƒ¼ã‚¯ãƒ³è§£æ: ã‚¨ãƒ©ãƒ¼');
            }

            // 4. Supabaseæ¥ç¶šçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
            const supabaseStatus = document.getElementById('supabaseStatus');
            try {
                if (typeof supabase !== 'undefined') {
                    const { data: { session }, error } = await supabase.auth.getSession();

                    if (error) throw error;

                    if (session) {
                        supabaseStatus.className = 'status success';
                        supabaseStatus.innerHTML = `âœ… Supabaseæ¥ç¶š: æ­£å¸¸<br>ã‚»ãƒƒã‚·ãƒ§ãƒ³: å­˜åœ¨<br>ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${session.user?.email || 'unknown'}`;
                        results.push('âœ… Supabase: æ¥ç¶šæˆåŠŸ');
                    } else {
                        supabaseStatus.className = 'status info';
                        supabaseStatus.textContent = 'â„¹ï¸ Supabaseæ¥ç¶š: æ­£å¸¸ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—ï¼‰';
                        results.push('â„¹ï¸ Supabase: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—');
                    }
                } else {
                    throw new Error('SupabaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            } catch (error) {
                supabaseStatus.className = 'status error';
                supabaseStatus.textContent = 'âŒ Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message;
                results.push('âŒ Supabase: ã‚¨ãƒ©ãƒ¼');
            }

            // 5. çµæœã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = results.map(r => `<div style="padding: 8px; margin: 5px 0; background: #fff; border-radius: 4px;">${r}</div>`).join('');
        }
    </script>
</body>
</html>
