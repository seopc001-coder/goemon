<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¼ãƒˆè¨ºæ–­ãƒ„ãƒ¼ãƒ« | äº”å³è¡›é–€</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .content {
            padding: 30px;
        }
        .section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #667eea;
            border-radius: 2px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }
        .info-value.success {
            color: #28a745;
        }
        .info-value.error {
            color: #dc3545;
        }
        .info-value.warning {
            color: #ffc107;
        }
        .cart-items {
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }
        .cart-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-warning { color: #dcdcaa; }
        .log-info { color: #9cdcfe; }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-badge.online {
            background: #d4edda;
            color: #155724;
        }
        .status-badge.offline {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›’ ã‚«ãƒ¼ãƒˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
            <p>èªè¨¼çŠ¶æ…‹ã¨ã‚«ãƒ¼ãƒˆã®çŠ¶æ…‹ã‚’è©³ç´°ã«ç¢ºèªã§ãã¾ã™</p>
        </div>

        <div class="content">
            <!-- èªè¨¼çŠ¶æ…‹ -->
            <div class="section">
                <h2>ğŸ” èªè¨¼çŠ¶æ…‹</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">localStorage Flag</div>
                        <div class="info-value" id="authFlag">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Supabase Session</div>
                        <div class="info-value" id="supabaseSession">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">User Email</div>
                        <div class="info-value" id="userEmail">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">åˆ¤å®šçµæœ</div>
                        <div class="info-value" id="authResult">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ã‚«ãƒ¼ãƒˆçŠ¶æ…‹ -->
            <div class="section">
                <h2>ğŸ“¦ ã‚«ãƒ¼ãƒˆçŠ¶æ…‹</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">localStorage ã‚«ãƒ¼ãƒˆ</div>
                        <div class="info-value" id="localCartCount">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Supabase ã‚«ãƒ¼ãƒˆ</div>
                        <div class="info-value" id="dbCartCount">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è¡¨ç¤ºã•ã‚Œã‚‹ã‚«ãƒ¼ãƒˆ</div>
                        <div class="info-value" id="displayCart">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">åˆè¨ˆé‡‘é¡</div>
                        <div class="info-value" id="totalAmount">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ã‚«ãƒ¼ãƒˆå†…å®¹ -->
            <div class="section">
                <h2>ğŸ›ï¸ ã‚«ãƒ¼ãƒˆå†…å®¹</h2>
                <div id="cartItemsDisplay" class="cart-items">
                    <div class="empty-state">
                        èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>

            <!-- ã‚³ãƒ³ã‚½ãƒ¼ãƒ« -->
            <div class="section">
                <h2>ğŸ’» è¨ºæ–­ãƒ­ã‚°</h2>
                <div id="consoleOutput" class="console-output">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>âš¡ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
                <div class="btn-group">
                    <button class="btn-primary" onclick="refreshAll()">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
                    <button class="btn-info" onclick="testAddToCart()">â• ãƒ†ã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </button>
                    <button class="btn-success" onclick="goToCart()">ğŸ›’ ã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã¸</button>
                    <button class="btn-danger" onclick="clearLocalCart()">ğŸ—‘ï¸ localStorage ã‚¯ãƒªã‚¢</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./js/supabase-config.js"></script>
    <script src="./js/goemon-user-db.js"></script>

    <script>
        let consoleLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEntry = `[${timestamp}] ${message}`;
            consoleLog.push({ message: logEntry, type });
            updateConsoleDisplay();
            console.log(message);
        }

        function updateConsoleDisplay() {
            const output = document.getElementById('consoleOutput');
            output.innerHTML = consoleLog.map(entry => {
                const className = `log-${entry.type}`;
                return `<div class="${className}">${entry.message}</div>`;
            }).join('');
            output.scrollTop = output.scrollHeight;
        }

        async function checkAuth() {
            log('=== èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯é–‹å§‹ ===', 'info');

            // localStorage Flag
            const isLoggedIn = localStorage.getItem('goemonloggedin') === 'true';
            document.getElementById('authFlag').textContent = isLoggedIn ? 'true (ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿)' : 'false (ã‚²ã‚¹ãƒˆ)';
            document.getElementById('authFlag').className = `info-value ${isLoggedIn ? 'success' : 'warning'}`;
            log(`localStorage goemonloggedin: ${isLoggedIn}`, isLoggedIn ? 'success' : 'warning');

            // Supabase Session
            const { data: { session } } = await supabase.auth.getSession();
            const hasSession = !!session;
            document.getElementById('supabaseSession').textContent = hasSession ? 'ã‚ã‚Š (èªè¨¼æ¸ˆã¿)' : 'ãªã— (ã‚²ã‚¹ãƒˆ)';
            document.getElementById('supabaseSession').className = `info-value ${hasSession ? 'success' : 'warning'}`;
            log(`Supabase session: ${hasSession ? 'å­˜åœ¨ã™ã‚‹' : 'å­˜åœ¨ã—ãªã„'}`, hasSession ? 'success' : 'warning');

            // User Email
            const email = session?.user?.email || 'ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼';
            document.getElementById('userEmail').textContent = email;
            document.getElementById('userEmail').className = `info-value ${session?.user ? 'success' : 'warning'}`;
            log(`User email: ${email}`, session?.user ? 'success' : 'info');

            // åˆ¤å®šçµæœ
            const bothTrue = isLoggedIn && hasSession;
            const resultText = bothTrue ? 'èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ (Supabaseä½¿ç”¨)' : 'ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ (localStorageä½¿ç”¨)';
            document.getElementById('authResult').textContent = resultText;
            document.getElementById('authResult').className = `info-value ${bothTrue ? 'success' : 'warning'}`;
            log(`æœ€çµ‚åˆ¤å®š: ${resultText}`, bothTrue ? 'success' : 'warning');

            log('=== èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯å®Œäº† ===', 'info');
            return { isLoggedIn, hasSession, session };
        }

        async function checkCart(authInfo) {
            log('=== ã‚«ãƒ¼ãƒˆçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯é–‹å§‹ ===', 'info');

            // localStorage Cart
            const rawLocalCart = localStorage.getItem('goemoncart');
            const localCart = JSON.parse(rawLocalCart) || [];
            document.getElementById('localCartCount').textContent = `${localCart.length} ä»¶`;
            document.getElementById('localCartCount').className = `info-value ${localCart.length > 0 ? 'success' : 'warning'}`;
            log(`localStorage ã‚«ãƒ¼ãƒˆ: ${localCart.length} ä»¶`, localCart.length > 0 ? 'success' : 'warning');
            log(`localStorage ç”Ÿãƒ‡ãƒ¼ã‚¿: ${rawLocalCart}`, 'info');

            // Supabase Cart
            let dbCart = [];
            if (authInfo.hasSession && authInfo.session?.user) {
                try {
                    dbCart = await fetchCartItems(authInfo.session.user.id);
                    document.getElementById('dbCartCount').textContent = `${dbCart.length} ä»¶`;
                    document.getElementById('dbCartCount').className = `info-value ${dbCart.length > 0 ? 'success' : 'warning'}`;
                    log(`Supabase ã‚«ãƒ¼ãƒˆ: ${dbCart.length} ä»¶`, dbCart.length > 0 ? 'success' : 'warning');
                } catch (error) {
                    document.getElementById('dbCartCount').textContent = 'ã‚¨ãƒ©ãƒ¼';
                    document.getElementById('dbCartCount').className = 'info-value error';
                    log(`Supabase ã‚«ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            } else {
                document.getElementById('dbCartCount').textContent = 'æœªèªè¨¼ (N/A)';
                document.getElementById('dbCartCount').className = 'info-value warning';
                log('Supabase ã‚«ãƒ¼ãƒˆ: æœªèªè¨¼ã®ãŸã‚å–å¾—ã—ãªã„', 'warning');
            }

            // è¡¨ç¤ºã•ã‚Œã‚‹ã‚«ãƒ¼ãƒˆ
            const bothTrue = authInfo.isLoggedIn && authInfo.hasSession;
            const displayedCart = bothTrue ? dbCart : localCart;
            const displaySource = bothTrue ? 'Supabase' : 'localStorage';
            document.getElementById('displayCart').textContent = `${displaySource} (${displayedCart.length} ä»¶)`;
            document.getElementById('displayCart').className = `info-value ${displayedCart.length > 0 ? 'success' : 'error'}`;
            log(`è¡¨ç¤ºã‚«ãƒ¼ãƒˆ: ${displaySource} ã‹ã‚‰ ${displayedCart.length} ä»¶`, displayedCart.length > 0 ? 'success' : 'error');

            // åˆè¨ˆé‡‘é¡
            let total = 0;
            displayedCart.forEach(item => {
                const price = item.price || 0;
                const quantity = item.quantity || 0;
                total += price * quantity;
            });
            document.getElementById('totalAmount').textContent = `Â¥${total.toLocaleString()}`;
            document.getElementById('totalAmount').className = `info-value ${total > 0 ? 'success' : 'warning'}`;
            log(`åˆè¨ˆé‡‘é¡: Â¥${total.toLocaleString()}`, total > 0 ? 'success' : 'warning');

            // ã‚«ãƒ¼ãƒˆå†…å®¹è¡¨ç¤º
            displayCartItems(displayedCart);

            log('=== ã‚«ãƒ¼ãƒˆçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯å®Œäº† ===', 'info');
        }

        function displayCartItems(items) {
            const container = document.getElementById('cartItemsDisplay');

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; opacity: 0.3;">ğŸ“­</div>
                        <div style="font-size: 16px; color: #999; margin-top: 10px;">ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map((item, index) => `
                <div class="cart-item">
                    <div>
                        <strong>#${index + 1} ${item.name || item.id || 'å•†å“åä¸æ˜'}</strong><br>
                        <small style="color: #666;">
                            ${item.color ? `è‰²: ${item.color}` : ''}
                            ${item.size ? `ã‚µã‚¤ã‚º: ${item.size}` : ''}
                        </small>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 18px; font-weight: 600; color: #667eea;">
                            Â¥${(item.price || 0).toLocaleString()}
                        </div>
                        <small style="color: #666;">æ•°é‡: ${item.quantity || 0}</small>
                    </div>
                </div>
            `).join('');
        }

        async function refreshAll() {
            consoleLog = [];
            log('ğŸ”„ è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™...', 'info');

            const authInfo = await checkAuth();
            await checkCart(authInfo);

            log('âœ… è¨ºæ–­å®Œäº†ï¼', 'success');
        }

        function testAddToCart() {
            log('â• ãƒ†ã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¾ã™...', 'info');

            const cart = JSON.parse(localStorage.getItem('goemoncart')) || [];
            const testItem = {
                id: 'test-' + Date.now(),
                name: 'ãƒ†ã‚¹ãƒˆå•†å“',
                price: 1000,
                quantity: 1,
                color: 'ãƒ›ãƒ¯ã‚¤ãƒˆ',
                size: 'M'
            };

            cart.push(testItem);
            localStorage.setItem('goemoncart', JSON.stringify(cart));

            log(`âœ… ãƒ†ã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸ: ${JSON.stringify(testItem)}`, 'success');

            setTimeout(refreshAll, 500);
        }

        function clearLocalCart() {
            if (!confirm('localStorageã®ã‚«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;

            log('ğŸ—‘ï¸ localStorageã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™...', 'warning');
            localStorage.removeItem('goemoncart');
            log('âœ… ã‚¯ãƒªã‚¢å®Œäº†', 'success');

            setTimeout(refreshAll, 500);
        }

        function goToCart() {
            window.location.href = 'goemon-cart.html';
        }

        // åˆæœŸå®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ ã‚«ãƒ¼ãƒˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ã‚’èµ·å‹•ã—ã¾ã—ãŸ', 'success');
            refreshAll();
        });
    </script>
</body>
</html>
