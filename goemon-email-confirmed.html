<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ¼ãƒ«èªè¨¼å®Œäº† | äº”å³è¡›é–€</title>

    <!-- Favicon -->

    <!-- Stylesheets -->
    <link rel="stylesheet" href="./css/goemon-style.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ -->
    <header class="header-simple">
        <div class="container">
            <div class="header-logo">
                <a href="/">
                    <h1>äº”å³è¡›é–€</h1>
                </a>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="auth-main">
        <div class="auth-container">
            <div class="auth-box">
                <!-- æˆåŠŸã‚¢ã‚¤ã‚³ãƒ³ -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <i class="fas fa-check-circle" style="font-size: 80px; color: #4CAF50;"></i>
                </div>

                <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                <h1 class="auth-title" style="text-align: center; margin-bottom: 20px;">
                    ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ
                </h1>

                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <p style="text-align: center; color: #666; margin-bottom: 40px; line-height: 1.8;">
                    ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®èªè¨¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚<br>
                    ã“ã‚Œã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚
                </p>

                <!-- ãƒã‚¤ãƒšãƒ¼ã‚¸/ã‚«ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
                <div class="form-submit">
                    <a href="goemon-mypage.html" class="btn-cmn-02" id="redirectButton" style="display: block; text-align: center; text-decoration: none;">
                        ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸
                    </a>
                </div>

                <!-- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ -->
                <div class="auth-footer" style="margin-top: 20px;">
                    <p><a href="/" class="link-text">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a></p>
                </div>
            </div>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ -->
    <footer class="footer-simple">
        <div class="container">
            <p>&copy; 2025 äº”å³è¡›é–€ All Rights Reserved.</p>
        </div>
    </footer>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./js/supabase-config.js"></script>
    <script src="./js/goemon-user-db.js"></script>
    <script src="./js/goemon-auto-logout.js"></script>
    <script>
        /**
         * ã‚«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’localStorageã‹ã‚‰Supabaseã«ç§»è¡Œï¼ˆæ—¢å­˜ã‚«ãƒ¼ãƒˆã¨ãƒãƒ¼ã‚¸ï¼‰
         */
        async function migrateCartToSupabase(userId) {
            try {
                // localStorageã‹ã‚‰ã‚«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const localCart = JSON.parse(localStorage.getItem('goemoncart')) || [];

                if (localCart.length === 0) {
                    console.log('ç§»è¡Œã™ã‚‹ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                console.log('ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ç§»è¡Œä¸­:', localCart.length, 'ä»¶');

                // Supabaseã«æ—¢å­˜ã®ã‚«ãƒ¼ãƒˆãŒã‚ã‚‹ã‹ç¢ºèª
                const existingCart = await fetchCartItems(userId);
                console.log('Supabaseæ—¢å­˜ã‚«ãƒ¼ãƒˆ:', existingCart?.length || 0, 'ä»¶');

                // Supabaseã«å„ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ï¼ˆæ—¢å­˜ã‚«ãƒ¼ãƒˆã¨ãƒãƒ¼ã‚¸ï¼‰
                for (const item of localCart) {
                    // åŒã˜å•†å“ãƒ»è‰²ãƒ»ã‚µã‚¤ã‚ºãŒæ—¢ã«Supabaseã‚«ãƒ¼ãƒˆã«ã‚ã‚‹ã‹ç¢ºèª
                    const existingItem = existingCart?.find(dbItem =>
                        String(dbItem.product_id) === String(item.id) &&
                        (dbItem.color || '') === (item.color || '') &&
                        (dbItem.size || '') === (item.size || '')
                    );

                    if (existingItem) {
                        // æ—¢å­˜ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚‹å ´åˆã¯æ•°é‡ã‚’æ›´æ–°ï¼ˆæ—¢å­˜ + è¿½åŠ ï¼‰
                        const newQuantity = existingItem.quantity + item.quantity;
                        console.log(`å•†å“ ${item.id} ã®æ•°é‡ã‚’æ›´æ–°: ${existingItem.quantity} â†’ ${newQuantity}`);
                        await updateCartItemQuantity(existingItem.id, newQuantity);
                    } else {
                        // æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
                        console.log(`å•†å“ ${item.id} ã‚’æ–°è¦è¿½åŠ `);
                        await addCartItemToDb(userId, {
                            productId: item.id,
                            quantity: item.quantity,
                            color: item.color || '',
                            size: item.size || ''
                        });
                    }
                }

                console.log('ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ');

                // ç§»è¡Œå®Œäº†å¾Œã€localStorageã®ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
                localStorage.removeItem('goemoncart');

            } catch (error) {
                console.error('ã‚«ãƒ¼ãƒˆç§»è¡Œã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã¯ç¶™ç¶š
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ç¶­æŒ
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Supabaseã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
                const { data: { user } } = await supabase.auth.getUser();

                if (user) {
                    console.log('User is authenticated:', user.email);
                    console.log('User metadata:', user.user_metadata);

                    // user_metadataãŒç©ºã®å ´åˆã€å†åº¦ç¢ºèª
                    if (!user.user_metadata || Object.keys(user.user_metadata).length === 0) {
                        console.warn('User metadata is empty. This may be a timing issue.');
                    }

                    // ã‚«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’localStorageã‹ã‚‰Supabaseã«ç§»è¡Œ
                    console.log('ğŸ›’ ã‚«ãƒ¼ãƒˆç§»è¡Œã‚’é–‹å§‹ã—ã¾ã™...');
                    await migrateCartToSupabase(user.id);

                    // ã‚«ãƒ¼ãƒˆç§»è¡Œå®Œäº†å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                    localStorage.setItem('goemonloggedin', 'true');
                    console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã¾ã—ãŸ');

                    // ä¿ç•™ä¸­ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã‚’ç¢ºèª
                    const pendingRedirect = localStorage.getItem('goemon_pending_redirect');
                    if (pendingRedirect) {
                        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                        const redirectButton = document.getElementById('redirectButton');
                        if (redirectButton) {
                            redirectButton.href = decodeURIComponent(pendingRedirect);
                            redirectButton.textContent = 'ã‚«ãƒ¼ãƒˆã«æˆ»ã‚‹';
                        }
                        // ä½¿ç”¨å¾Œã¯å‰Šé™¤
                        localStorage.removeItem('goemon_pending_redirect');
                    }
                } else {
                    console.log('No user session found');
                }
            } catch (error) {
                console.error('Error checking user session:', error);
            }
        });
    </script>
</body>
</html>
